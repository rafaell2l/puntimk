<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronistoria Attività Gerarchica</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f9f9f9;
            color: #333;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        /* ========== MODIFICA CHIAVE ========== */
        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column; /* Impila i pannelli verticalmente */
            gap: 30px; /* Crea spazio verticale tra i pannelli */
        }
        .panel {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }
        h1, h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }
        h2.secondary-title {
            margin-top: 30px;
            font-size: 1.2em;
        }
        textarea#inputText {
            min-height: 30vh; /* Altezza minima per l'input */
            resize: vertical;
        }
        textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
        }
        textarea#textOutput {
            height: 40vh;
            background-color: #fdfdfd;
            resize: vertical;
        }
        button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #htmlOutput {
            margin-top: 20px;
        }
        .topic-container {
            border-left: 2px solid #e0e0e0;
            padding-left: 20px;
            margin-top: 10px;
        }
        .topic-title {
            font-size: 1.1em;
            color: #d9534f;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        .topic-title:hover {
            background-color: #f5f5f5;
        }
        .toggle-icon {
            display: inline-block;
            width: 20px;
            font-family: monospace;
            font-weight: bold;
        }
        .topic-content.collapsed {
            display: none;
        }
        .direct-notes-section {
            padding: 10px 0 10px 0;
        }
        .topic-entry {
            margin-bottom: 12px;
            padding-left: 15px;
            border-left: 3px solid #ccc;
        }
        .topic-entry strong {
            display: block;
            font-size: 0.9em;
            color: #555;
        }
        .topic-entry pre {
            margin: 5px 0 0 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>

<!-- ========== STRUTTURA HTML RIORDINATA ========== -->
<div class="container">
    
    <!-- Pannello di Output (ora è il primo) -->
    <div class="panel">
        <h1>Output Interattivo</h1>
        <div id="htmlOutput">
            <p>I risultati appariranno qui...</p>
        </div>
        <h2 class="secondary-title">Output Testuale (per Copia/Incolla)</h2>
        <textarea id="textOutput" readonly placeholder="L'output testuale apparirà qui..."></textarea>
    </div>

    <!-- Pannello di Input (ora è il secondo, in fondo) -->
    <div class="panel">
        <h1>Input: Il tuo file.txt</h1>
        <p>Usa più tag come <code>[Tag1] [Tag2]</code> per categorizzare una nota in più punti.</p>
        <textarea id="inputText" placeholder="Punti 01/03 lunedì:&#10;- Correzione bug login [Verdi/Gestionale] [Bugfix]"></textarea>
        <button onclick="processText()">Crea Cronistoria</button>
    </div>

</div>

<script>
    // IL JAVASCRIPT RIMANE COMPLETAMENTE INVARIATO
    document.getElementById('htmlOutput').addEventListener('click', function(event) {
        const title = event.target.closest('.topic-title');
        if (title) {
            const content = title.nextElementSibling;
            if (content && content.classList.contains('topic-content')) {
                content.classList.toggle('collapsed');
                const icon = title.querySelector('.toggle-icon');
                if (icon) {
                    icon.textContent = content.classList.contains('collapsed') ? '►' : '▼';
                }
            }
        }
    });

    function processText() {
        const text = document.getElementById('inputText').value;
        const allPoints = parseInputText(text);
        const groupedTree = groupPointsIntoTree(allPoints);
        renderHtmlOutput(groupedTree);
        renderTextOutput(groupedTree);
    }

    function parseInputText(text) {
        const lines = text.split('\n');
        const points = [];
        let currentDate = "N/D", currentDay = "", currentPoint = null;
        const dateWithDayRegex = /^Punti\s+(\d{2}\/\d{2})\s+(.+?):/;
        const dateOnlyRegex = /^Punti\s+(\d{2}\/\d{2}):/;
        const tagRegex = /\[([^\]]+)\]/g;
        const pointRegex = /^\s*-\s+(.*)/;
        lines.forEach(line => {
            let dateMatch = line.match(dateWithDayRegex);
            if (dateMatch) {
                currentDate = dateMatch[1];
                currentDay = dateMatch[2].trim();
                currentPoint = null;
                return;
            }
            let dateOnlyMatch = line.match(dateOnlyRegex);
            if (dateOnlyMatch) {
                currentDate = dateOnlyMatch[1];
                currentDay = "";
                currentPoint = null;
                return;
            }
            let pointMatch = line.match(pointRegex);
            if (pointMatch) {
                const content = pointMatch[1];
                const tags = Array.from(content.matchAll(tagRegex), m => m[1]);
                const cleanContent = content.replace(tagRegex, '').trim();
                currentPoint = { date: currentDate, day: currentDay, content: cleanContent, tags: tags };
                points.push(currentPoint);
                return;
            }
            if (currentPoint && line.trim().length > 0) {
                currentPoint.content += '\n' + line;
            }
        });
        return points;
    }

    function groupPointsIntoTree(points) {
        const root = {};
        points.forEach(point => {
            if (!point.tags || point.tags.length === 0) return;
            point.tags.forEach(tag => {
                let cleanTag = tag;
                const isDirectNote = tag.endsWith('.');
                if (isDirectNote) cleanTag = tag.slice(0, -1);
                if (!cleanTag) return;
                const path = cleanTag.split('/');
                let currentNode = root;
                for (const part of path) {
                    if (!part) continue;
                    if (!currentNode[part]) currentNode[part] = {};
                    currentNode = currentNode[part];
                }
                if (!currentNode._notes) currentNode._notes = [];
                currentNode._notes.push({ date: point.date, day: point.day, content: point.content });
            });
        });
        return root;
    }

    function renderHtmlOutput(tree) {
        const outputDiv = document.getElementById('htmlOutput');
        outputDiv.innerHTML = '';
        const sortedKeys = Object.keys(tree).sort();
        if (sortedKeys.length === 0) {
            outputDiv.innerHTML = '<p>Nessun argomento trovato.</p>';
            return;
        }
        sortedKeys.forEach(key => renderNode(tree[key], key, outputDiv));
    }

    function renderNode(node, name, parentElement) {
        const container = document.createElement('div');
        container.className = 'topic-container';
        const childrenKeys = Object.keys(node).filter(k => k !== '_notes');
        const hasChildren = childrenKeys.length > 0;
        const hasDirectNotes = node._notes && node._notes.length > 0;
        const isCollapsible = hasChildren || hasDirectNotes;
        const title = document.createElement('h2');
        title.className = 'topic-title';
        title.innerHTML = `<span class="toggle-icon">${isCollapsible ? '►' : ''}</span> ${name}`;
        const content = document.createElement('div');
        content.className = `topic-content ${isCollapsible ? 'collapsed' : ''}`;
        if (hasDirectNotes) {
            const directNotesDiv = document.createElement('div');
            directNotesDiv.className = 'direct-notes-section';
            node._notes.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'topic-entry';
                const dayString = entry.day ? ` ${entry.day}` : '';
                entryDiv.innerHTML = `<strong>Data: ${entry.date}${dayString}</strong><pre>${escapeHtml(entry.content)}</pre>`;
                directNotesDiv.appendChild(entryDiv);
            });
            content.appendChild(directNotesDiv);
        }
        if (hasChildren) {
            childrenKeys.sort().forEach(key => renderNode(node[key], key, content));
        }
        container.appendChild(title);
        container.appendChild(content);
        parentElement.appendChild(container);
    }

    function renderTextOutput(tree) {
        const textOutputArea = document.getElementById('textOutput');
        let fullText = '';
        const sortedKeys = Object.keys(tree).sort();
        if (sortedKeys.length === 0) {
            textOutputArea.value = 'Nessun argomento trovato.';
            return;
        }
        sortedKeys.forEach(key => fullText += generateNodeText(tree[key], key, 0));
        textOutputArea.value = fullText.trim();
    }

    function generateNodeText(node, name, indentLevel) {
        let output = '';
        const indent = '  '.repeat(indentLevel);
        output += `${indent}📁 ${name}\n`;
        if (node._notes && node._notes.length > 0) {
            node._notes.forEach(entry => {
                const noteLines = entry.content.split('\n');
                const dayString = entry.day ? ` ${entry.day}` : '';
                output += `${indent}  [${entry.date}${dayString}] - ${noteLines[0]}\n`;
                for (let i = 1; i < noteLines.length; i++) {
                    output += `${indent}      ${noteLines[i]}\n`;
                }
            });
        }
        const childrenKeys = Object.keys(node).filter(k => k !== '_notes').sort();
        if (childrenKeys.length > 0) {
            if (node._notes && node._notes.length > 0) output += '\n';
            childrenKeys.forEach(key => output += generateNodeText(node[key], key, indentLevel + 1));
        }
        return output + '\n';
    }

    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>

</body>
</html>
